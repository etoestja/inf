---
title: "Сравнение моделей регрессии"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# setwd("./S-5")
```

## 


```{r}
rmodels <- read.table(file = "rmodels.txt", stringsAsFactors = F, header = T)

plot(density(rmodels$err1))
lines(density(rmodels$err2), col=2)
```



Проверьте данные на нормальность. Можно ли использовать qq-график для обоснования использования методов, подразумевающих нормальность? То есть можем ли мы на основе qq-графика удостовериться в том, что, например, двухвыборочный t-критерий Стьюдента использовать правомернo?  
```{r}
par(mfrow=c(1,2))
qqnorm(rmodels$err1)
qqline(rmodels$err1, col=2)
qqnorm(rmodels$err2)
qqline(rmodels$err2, col=2)

shapiro.test(rmodels$err1)
shapiro.test(rmodels$err2)
shapiro.test(rmodels$err2 - rmodels$err1)
```



## Критерий Уилкоксона-Манна-Уитни для независимых выборок. 


Первая идея, которая посещает голову попсового статиста, когда он слышит слова "гипотеза о равенстве средних", это конечно t-критерий Стьюдента.  Это и понятно --  действительно, если данные приходят из нормального распределения, то этот критериий достаточно мощный и использовать следует именно его. Кроме того, этот критерий достаточно устойчив к незначительным отклонениям от нормальности. 


При этом на практике и в индустрии подавляющее большинство реальных данных никогда не распределено по нормальному закону. Есть ли хорошие альтернативы этому критерию?


Такой альтернативой, которую часто исопльзуют на практике, является критерий ранговых сумм Уилкоксона-Манна-Уитни. Рассмотрим модель смеси двух нормальных распределений 
$$F(x) = (1 - \varepsilon) \Phi(x) + \Phi(x/3)  $$ 

Интересно, что уже при $\varepsilon \geq 0.01$   критерий ранговых сумм становится более точным критерием (имеет меньшую асимптотическую дисперсию), чем t-критерий. Кроме того есть теорема, что этот критерий не может потерять в асимптотической точности больше, чем 14% и может быть сколь угодно более точным, чем t-критерий. Именно поэтому критерий ранговых сумм так важен для практического применения. 

Проверьте гипотезу об однородности двух распределений, из которых получены выборки с помощью критерия Уилкоксона-Манна-Уитни.

```{r}
# type your code here
wilcox.test(x = rmodels$err1, y = rmodels$err2)
```




## Двухвыборочный перестановочный критерий для независимых выборок. 

Другим мощным классом статистических критериев является класс перестановочных критериев. 

Чтобы лучше понять сферу применений перестановочного критерия, дадим некоторое его сравнение с t-критерием:


* t-критерий формирует нулевую гипотезу относительно равенства средних, перестановочные критерии, как правило, задают нулевую гипотезу более широко --  в терминах равенства распределений
*  Двухвыборочный t-критерий подразумевает, что нормальным должно быть распределение разностей $\bar{X}_1 - \bar{X}_2$, и основывается на том, что правильным образом отнормированная эта разность распределена по закону Стьюдента. Перестановочные критерии  считают статистику по данным, не прибегая к гипотезам о конкретном виде распределения, и оценивают распределение с помощью повторных выборок из данных. 

* t-критерий дает точные значения достигаемого уровня значимости только если разность между средними в двух группах имеет распределение не сильно отклоняющееся от нормального. Перестановочный тест дает точное значение p-value даже если распределение очень сильно отклоняется от нормального.  

* Перестановочный тест часто используется, когда нужна большая точность и предположение о нормальности данных нереалистично, а также для того, чтобы проверить эти предположения.  



В частности, для проверки этого предположения часто прибегают к следующей процедуре. 
Из объединенной выборки выбирают случайно по схеме без возвращения столько объектов, сколько было изначально в одной из них (скажем, в первой). Остальные объекты полагают попавшими во вторую группу. Дальше считают некоторую статистику (в данном случае разницу средних значениях в этих двух группах) и ее запоминают. 

Повторяя такую процедуру много раз, достигаемый уровень значимости получают как долю  значений статистики (разности средних в нашем примере) таких же или более экстремальных, чем значение статистики, которое получилось по исходным выборкам (из которых мы делаем псевдовыборки). Если это значение находится далеко от p-value t-критерия, то считается, что t-критерий для этих данных ненадежен. 

Тонкий вопрос о том, сколько нужно сделать таких псевдовыборок, решают следующим образом. Если истинное значение достигаемого уровня значимости равно $p$, то стандартное отклонение оценки p-value равно $\sqrt{ p(1-p) / B }$, где $B$ - это количество сделанных псевдовыборок. Часто также переходят к верхней оценке этого значения ($\sqrt{ 1/ (4B) }$). 


* Реализуйте подобную процедуру самостоятельно для точности порядка $10^{-4}$. 
* Cравните получившееся p-value с таковым для t-критерия. 
* Cравните получившееся p-value с таковым для стандартной функции `perm.test`. 
* Cравните получившееся p-value с таковым для критерий Манна-Уитни `wilcox.test`. 


```{r}
library(exactRankTests)
# type your code here
```




## Двухвыборочный перестановочный критерий для зависмых выборок. 

В случае, если выборки связаны, то предыдущая схема неприменима: нет смысла переставлять значения между разными объектам. В таком случае прибегают к тому, что переставляют значения внутри каждого объекта, получая таким образом новые псевдовыборки, по которым также считают статистику и запоминают ее. Повторяя такую процедуру много раз, p-value находят также, как и в предыдущем случае  -- считая долю таких же или еще более экстремальных значений статистики по псевдовыборкам в сравнении со статистикой, посчитанной по исходной выборке. 

* Реализуйте описанную процедуру самостоятельно для точности порядка $10^{-4}$. 
* Cравните получившееся p-value с таковым для t-критерия. 
* Cравните получившееся p-value с таковым для стандартной функции `perm.test`. 
* Cравните получившееся p-value с таковым для критерий Манна-Уитни `wilcox.test`. 

Не забудьте, что вам в данном случае каждый из критериев нужно вызвать с параметрами, соответствующими связанным выборкам. 

```{r}
# type your code here
```
















