---
title: "Кардиотокография"
output: html_document
---

# ЕСЛИ ВЫ ОЧЕНЬ УСТАЛИ ПОДБИРАТЬ МОДЕЛЬ, ПЕРЕХОДИТЕ К ПУНКТАМ 13-15 -- ОНИ САМЫЕ ВАЖНЫЕ!!

## Постановка задачи

Кардиотокография — диагностическая техника, фиксирующая сердцебиение плода и тонус матки и позволяющая оценить состояние эмбриона. Непосредственный результат наблюдений интерпретировать крайне сложно. Чтобы облегчить задачу диагностики, результаты кардиотокографии 1831 эмбрионов были классифицированы опытными специалистами на нормальные и патологические, а на основе показаний прибора было сгенерировано 22 признака.
Ставится задача построения функции, определяющей вероятность наличия патологии по описанию кардиотокограммы и оценки вклада признаков.

## Решение.



```{r results='hide', warning=FALSE, message=FALSE, echo=FALSE}
library(mfp)
library(lattice)
library(AUC)
library(plyr)
library(lmtest)
```


Посмотрим на распределения непрерывных признаков в классах:

```{r, echo=FALSE, fig.height=10, fig.width=10, warning=FALSE}
data <- read.csv('CTG_data.csv')                 
data$Tendency <- factor(data$Tendency, levels=c("0","1","-1"))

par(mfrow=c(4,5), mar=c(4, 2, 2, 1))
for (i in c(1:5, 7, 9:21)){
  d1 <- density(data[data$NSP == "N",i])
  d2 <- density(data[data$NSP == "P",i])
  plot(d1, col="blue", xlim=c(min(d1$x, d2$x), max(d1$x, d2$x)), ylim=c(min(d1$y, d2$y), max(d1$y, d2$y)), xlab=colnames(data)[i], main="")
  lines(d2, col="red")
}

plot(1, type = "n", axes=FALSE, xlab="", ylab="")
legend("center", c("Normal", "Pathological"), lty=c(1,1), col=c("blue", "red"))
```


1. Изучите внимательно распределения непрерывных признаков в классах. Можно ли разделить классы по одному из признаков?

2. Нам известно, что признаки "DS", "DR" и "Tendency" необходимо рассматривать как категориальные. Постройте таблицы сопряжённости по этим признакам с помощью функции `table`. Удалите из вырожденные признаки (признак вырожденный, если для каждого класса он принимает одно и то же значение в 95% случаев).

```{r, warning=FALSE}
# Type your code here
#table(data$DS, data$NSP)
#data$DS <- NULL
#table(data$DR, data$NSP)
#data$DR <- NULL
table(data$Tendency)
with(data, table(Tendency, NSP))
```

#### Модель 0

3. Постройте одномерные модели логистической регрессии по каждому из факторов. (Метка класса содержится в столбце NSP, все остальные столбцы можно использовать как факторы). Воспользуйтесь тестом отношения правдоподобия для пероверки значимости каждого из признаков.  Какие признаки оказались значимы на уровне 0.25? 

(Подсказка: С помощью функции `glm` постройте настройте intercept модели, а затем воспользуйтесь функцией `add1` чтобы добавить все возможные факторы. Обратите внимание на опцции функции `add1`).

```{r, warning=FALSE}
# Type your code here
str(data$NSP)
table(data$NSP)
data$NSP.levels
data$NSP <- as.numeric(data$NSP) - 1
```
```{r}
glm(NSP ~ ., family = "binomial", data = data)
```

```{r}
m <- glm(NSP ~ 1, family = "binomial", data = data)
add1(m, names(data), test = "LRT")
```

#### Модель 1

4. Постройте многомерную модель со всеми предикторами, значимыми на уровне 0.25
```{r, echo=TRUE, warning=TRUE}
m1 <- glm(NSP ~ . - (LB + Nzeros), family = "binomial", data = data)
# Type your code here 
library(usdm)
vif(data)
```

5. Получилось ли определить все коэффициенты? С чем это связано?

Для каждого из признаков попробуйте выкинуть его из построенной модели. Получите модель, в которой получается восстановить все коэффициенты выкинув всего один признак.

```{r, echo=TRUE, warning=TRUE}
# Type your code here
m2 <- glm(NSP ~ . - (LB + Nzeros + Max), family = "binomial", data = data)
library(lmtest)
lrtest(m2)
```

#### Модель 2

6. Постройте ещё раз модель с устранённой коллинеарностью (без одного признака). Сравните её с предсказание такой модели с наилучшим предсказанием константы (Модель 0) при помощи теста отношения праводоподобия `lrtest`. 

```{r, echo=TRUE, warning=FALSE}
# Type your code here
lrtest(m, m2)
```

#### Модели 3

7. Попробуйте выбросить все незначимые признаки из модели. 

```{r, echo=TRUE, warning=FALSE}
# Type your code here
m3 <- glm(NSP ~ . - (LB + Nzeros + Max + Mean), family = "binomial", data = data)
summary.glm(m3)
lrtest(m2, m3)
```

8. Проверьте значимость всех признаков в полученной модели. 

```{r, echo=TRUE, warning=FALSE}
# Type your code here
```

#### Модель 4

9. Проверьте линейность логита по каждому непрерывному признаку (функция `ksmooth`). Можно ли сказать о линейности для каждого из признака? Если нет, попробуйте подобрать дробные полиномы (функция `mfp` из пакета `mfp`) Сравните получившуюся модель с текущей лучшей моделью. 

```{r, echo=TRUE, warning=FALSE}
# Type your code here
boundaries <- range(data$MSTV)
r <- seq(boundaries[1], boundaries[2], 0.01)
plot(with(data = data, ksmooth(x = MSTV, y = NSP)))
```

10. Попробуйте добавить попарные взаимодействия всех признаков. Отберите несколько наиболее значимых комбинаций и добавьте в модель. Улучшился ли результат?

```{r, echo=TRUE, warning=FALSE}
# Type your code here
```

11. Попробуйте удалить несколько признаков по наименьшей значимости (функция `drop1`). Стала ли модель лучше по критерию отношения правдоподобия?


```{r, echo=TRUE, warning=FALSE}
# Type your code here
```


#### Модель 5

12. Попробуйте удалить влиятельные наблюдения с по растоянию Кука. Перенастройте модель и сравните с лучшей. Значимо ли изменились коэффициенты модели?

```{r, echo=TRUE, warning=FALSE}
# Type your code here
```


#### Итог

13. Возьмите лучшую из построенных моделей и постройте предсказания вероятности патологии для неё.
Постройте графики sensitivity и specificity, а также roc-кривую. (Функции `specificity`, `sensitivity`, `roc` и `auc`s из библиотеки `AUC`). Какое значение порога стоит выставить чтобы получить достойное значение обоих критерив?

```{r, echo=TRUE, fig.height=5.5, fig.width=10}
# Type your code here
```

14. Оцените значимость модели (p-value) по критерию отношения правдоподобия,а также приросты отношений шансов на патологию для каждого признака и доверительные интервалы для них.
```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Type your code here
```

Расшифровки обозначений для признаков в финальной модели:

- AC - число ускорений в секунду;
- UC - число сокращений матки;
- DP - число длительных замедлений в секунду;
- ASTV - процент абнормальных краткосрочных изменений;
- ALTV - процент абнормальных долгосрочных изменений;
- Max - максимум гистограммы FHR;
- Nmax - число раз, которое достигается максимум в гистограмме FHR;
- Mode - мода гистограммы FHR;
- Variance - дисперсия гистограммы FHR.

15. Постройте доверительные интервалы на влияние каждого признака на отклик (например: "Увеличив число ускорений в секунду на единицу риск патологии увеличивается в 10000 раз (95%-доверительный интервал [9990, 10010])")

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Type your code here
```
